from data.utils import get_stack_data
from tools import stopwatch


RESERVED_WORDS_BY_LANGUAGE: dict[str, list[str]] = {
    "C": [
        "_Bool",
        "_Complex",
        "_Imaginary",
        "auto",
        "break",
        "case",
        "char",
        "const",
        "continue",
        "default",
        "do",
        "double",
        "else",
        "enum",
        "extern",
        "float",
        "for",
        "goto",
        "if",
        "inline",
        "int",
        "long",
        "register",
        "restrict",
        "return",
        "short",
        "signed",
        "sizeof",
        "static",
        "struct",
        "switch",
        "typedef",
        "union",
        "unsigned",
        "void",
        "volatile",
        "while",
    ],
    "C++": [
        "alignas",
        "alignof",
        "and",
        "and_eq",
        "asm",
        "atomic_cancel",
        "atomic_commit",
        "atomic_noexcept",
        "auto",
        "bitand",
        "bitor",
        "bool",
        "break",
        "case",
        "catch",
        "char",
        "char16_t",
        "char32_t",
        "class",
        "compl",
        "concept",
        "const",
        "const_cast",
        "consteval",
        "constexpr",
        "constinit",
        "continue",
        "co_await",
        "co_return",
        "co_yield",
        "decltype",
        "default",
        "delete",
        "do",
        "double",
        "dynamic_cast",
        "else",
        "enum",
        "explicit",
        "export",
        "extern",
        "false",
        "float",
        "for",
        "friend",
        "goto",
        "if",
        "inline",
        "int",
        "long",
        "mutable",
        "namespace",
        "new",
        "noexcept",
        "not",
        "not_eq",
        "nullptr",
        "operator",
        "or",
        "or_eq",
        "private",
        "protected",
        "public",
        "register",
        "reinterpret_cast",
        "requires",
        "return",
        "short",
        "signed",
        "sizeof",
        "static",
        "static_assert",
        "static_cast",
        "struct",
        "switch",
        "template",
        "this",
        "thread_local",
        "throw",
        "true",
        "try",
        "typedef",
        "typeid",
        "typename",
        "union",
        "unsigned",
        "using",
        "virtual",
        "void",
        "volatile",
        "wchar_t",
        "while",
        "xor",
        "xor_eq",
    ],
    "C-Sharp": [
        "abstract",
        "as",
        "base",
        "bool",
        "break",
        "byte",
        "case",
        "catch",
        "char",
        "checked",
        "class",
        "const",
        "continue",
        "decimal",
        "default",
        "delegate",
        "do",
        "double",
        "else",
        "enum",
        "event",
        "explicit",
        "extern",
        "false",
        "finally",
        "fixed",
        "float",
        "for",
        "foreach",
        "goto",
        "if",
        "implicit",
        "in",
        "int",
        "interface",
        "internal",
        "is",
        "lock",
        "long",
        "namespace",
        "new",
        "null",
        "object",
        "operator",
        "out",
        "override",
        "params",
        "private",
        "protected",
        "public",
        "readonly",
        "ref",
        "return",
        "sbyte",
        "sealed",
        "short",
        "sizeof",
        "stackalloc",
        "static",
        "string",
        "struct",
        "switch",
        "this",
        "throw",
        "true",
        "try",
        "typeof",
        "uint",
        "ulong",
        "unchecked",
        "unsafe",
        "ushort",
        "using",
        "virtual",
        "void",
        "volatile",
        "while",
        "record",
        "init",
        "async",
        "await",
        "partial",
        "yield",
    ],
    "CSS": [
        "@charset",
        "@container",
        "@font-face",
        "@import",
        "@keyframes",
        "@layer",
        "@media",
        "@namespace",
        "@page",
        "@supports",
        "background",
        "border",
        "color",
        "display",
        "flex",
        "font",
        "grid",
        "margin",
        "padding",
        "position",
        "transform",
    ],
    "Dart": [
        "abstract",
        "as",
        "assert",
        "async",
        "await",
        "break",
        "case",
        "catch",
        "class",
        "const",
        "continue",
        "covariant",
        "default",
        "deferred",
        "do",
        "dynamic",
        "else",
        "enum",
        "export",
        "extends",
        "extension",
        "external",
        "factory",
        "false",
        "final",
        "finally",
        "for",
        "Function",
        "get",
        "hide",
        "if",
        "implements",
        "import",
        "in",
        "interface",
        "is",
        "late",
        "library",
        "mixin",
        "new",
        "null",
        "on",
        "operator",
        "part",
        "rethrow",
        "return",
        "set",
        "show",
        "static",
        "super",
        "switch",
        "sync",
        "this",
        "throw",
        "true",
        "try",
        "typedef",
        "var",
        "void",
        "while",
        "with",
        "yield",
    ],
    "Diff": [
        "@@",
        "+++",
        "---",
        "deleted file mode",
        "diff --git",
        "index",
        "new file mode",
        "rename from",
        "rename to",
        "similarity index",
    ],
    "Go": [
        "break",
        "case",
        "chan",
        "const",
        "continue",
        "default",
        "defer",
        "else",
        "fallthrough",
        "for",
        "func",
        "go",
        "goto",
        "if",
        "import",
        "interface",
        "map",
        "package",
        "range",
        "return",
        "select",
        "struct",
        "switch",
        "type",
        "var",
    ],
    "GraphQL": [
        "directive",
        "enum",
        "extend",
        "false",
        "fragment",
        "implements",
        "input",
        "interface",
        "mutation",
        "null",
        "on",
        "query",
        "scalar",
        "schema",
        "subscription",
        "true",
        "type",
        "union",
    ],
    "Perl": [
        "break",
        "case",
        "continue",
        "default",
        "do",
        "else",
        "elsif",
        "for",
        "foreach",
        "given",
        "goto",
        "if",
        "last",
        "my",
        "next",
        "our",
        "package",
        "redo",
        "return",
        "state",
        "sub",
        "undef",
        "unless",
        "use",
        "when",
        "while",
    ],
    "PHP": [
        "abstract",
        "and",
        "array",
        "as",
        "break",
        "callable",
        "case",
        "catch",
        "class",
        "clone",
        "const",
        "continue",
        "declare",
        "default",
        "die",
        "do",
        "echo",
        "else",
        "elseif",
        "empty",
        "enddeclare",
        "endfor",
        "endforeach",
        "endif",
        "endswitch",
        "endwhile",
        "eval",
        "exit",
        "extends",
        "final",
        "finally",
        "for",
        "foreach",
        "function",
        "global",
        "goto",
        "if",
        "implements",
        "include",
        "include_once",
        "instanceof",
        "insteadof",
        "interface",
        "isset",
        "list",
        "namespace",
        "new",
        "null",
        "or",
        "print",
        "private",
        "protected",
        "public",
        "require",
        "require_once",
        "return",
        "static",
        "switch",
        "throw",
        "trait",
        "true",
        "try",
        "unset",
        "use",
        "var",
        "while",
        "xor",
        "false",
        "yield",
    ],
    "Text": [],
    "Python": [
        "False",
        "None",
        "True",
        "and",
        "as",
        "assert",
        "async",
        "await",
        "break",
        "class",
        "continue",
        "def",
        "del",
        "elif",
        "else",
        "except",
        "finally",
        "for",
        "from",
        "global",
        "if",
        "import",
        "in",
        "is",
        "lambda",
        "match",
        "case",
        "nonlocal",
        "not",
        "or",
        "pass",
        "raise",
        "return",
        "try",
        "while",
        "with",
        "yield",
    ],
    "R": [
        "FALSE",
        "Inf",
        "NA",
        "NA_character_",
        "NA_complex_",
        "NA_integer_",
        "NA_real_",
        "NULL",
        "NaN",
        "TRUE",
        "break",
        "else",
        "for",
        "function",
        "if",
        "in",
        "next",
        "repeat",
        "while",
    ],
    "Ruby": [
        "BEGIN",
        "END",
        "alias",
        "and",
        "begin",
        "break",
        "case",
        "class",
        "def",
        "defined?",
        "do",
        "else",
        "elsif",
        "end",
        "ensure",
        "false",
        "for",
        "if",
        "in",
        "module",
        "next",
        "nil",
        "not",
        "or",
        "redo",
        "rescue",
        "retry",
        "return",
        "self",
        "super",
        "then",
        "true",
        "undef",
        "unless",
        "until",
        "when",
        "while",
        "yield",
    ],
    "Rust": [
        "Self",
        "as",
        "async",
        "await",
        "break",
        "const",
        "continue",
        "crate",
        "dyn",
        "else",
        "enum",
        "extern",
        "false",
        "fn",
        "for",
        "if",
        "impl",
        "in",
        "let",
        "loop",
        "match",
        "mod",
        "move",
        "mut",
        "pub",
        "ref",
        "return",
        "self",
        "static",
        "struct",
        "super",
        "trait",
        "true",
        "type",
        "unsafe",
        "use",
        "where",
        "while",
    ],
    "SCSS": [
        "@each",
        "@else",
        "@extend",
        "@for",
        "@forward",
        "@function",
        "@if",
        "@import",
        "@include",
        "@mixin",
        "@return",
        "@use",
        "@while",
        "$",
    ],
    "Shell": [
        "alias",
        "case",
        "coproc",
        "declare",
        "do",
        "done",
        "elif",
        "else",
        "esac",
        "export",
        "fi",
        "for",
        "function",
        "if",
        "in",
        "local",
        "readonly",
        "select",
        "then",
        "time",
        "typeset",
        "unalias",
        "unset",
        "until",
        "while",
    ],
    "SQL": [
        "alter",
        "and",
        "as",
        "by",
        "case",
        "create",
        "delete",
        "distinct",
        "drop",
        "end",
        "from",
        "full",
        "group",
        "having",
        "inner",
        "insert",
        "into",
        "is",
        "join",
        "left",
        "limit",
        "null",
        "offset",
        "on",
        "or",
        "order",
        "outer",
        "right",
        "select",
        "table",
        "then",
        "union",
        "update",
        "values",
        "when",
        "where",
    ],
    "Swift": [
        "Any",
        "Self",
        "_",
        "actor",
        "as",
        "associatedtype",
        "async",
        "await",
        "break",
        "case",
        "catch",
        "class",
        "continue",
        "default",
        "defer",
        "deinit",
        "do",
        "else",
        "enum",
        "extension",
        "fallthrough",
        "false",
        "fileprivate",
        "for",
        "func",
        "guard",
        "if",
        "import",
        "in",
        "init",
        "inout",
        "internal",
        "is",
        "let",
        "nil",
        "nonisolated",
        "open",
        "operator",
        "private",
        "protocol",
        "public",
        "repeat",
        "rethrows",
        "return",
        "self",
        "some",
        "static",
        "struct",
        "subscript",
        "super",
        "switch",
        "throw",
        "throws",
        "true",
        "try",
        "typealias",
        "var",
        "where",
        "while",
    ],
    "TypeScript": [
        "abstract",
        "any",
        "as",
        "asserts",
        "async",
        "await",
        "boolean",
        "break",
        "case",
        "catch",
        "class",
        "const",
        "continue",
        "debugger",
        "declare",
        "default",
        "delete",
        "do",
        "else",
        "enum",
        "export",
        "extends",
        "false",
        "finally",
        "for",
        "function",
        "if",
        "implements",
        "import",
        "in",
        "infer",
        "instanceof",
        "interface",
        "keyof",
        "let",
        "module",
        "namespace",
        "never",
        "new",
        "null",
        "number",
        "object",
        "override",
        "private",
        "protected",
        "public",
        "readonly",
        "require",
        "return",
        "static",
        "string",
        "super",
        "switch",
        "this",
        "throw",
        "true",
        "try",
        "type",
        "typeof",
        "undefined",
        "unknown",
        "var",
        "void",
        "while",
        "with",
        "yield",
        "satisfies",
    ],
    "Visual_Basic_.NET": [
        "AddHandler",
        "AddressOf",
        "Alias",
        "And",
        "AndAlso",
        "As",
        "Boolean",
        "ByRef",
        "Byte",
        "ByVal",
        "Call",
        "Case",
        "Catch",
        "CBool",
        "CByte",
        "CChar",
        "CDate",
        "CDec",
        "CDbl",
        "Char",
        "CInt",
        "Class",
        "CLng",
        "CObj",
        "Const",
        "Continue",
        "CSByte",
        "CShort",
        "CSng",
        "CStr",
        "CType",
        "CUInt",
        "CULng",
        "CUShort",
        "Date",
        "Decimal",
        "Declare",
        "Default",
        "Delegate",
        "Dim",
        "DirectCast",
        "Do",
        "Double",
        "Each",
        "Else",
        "ElseIf",
        "End",
        "EndIf",
        "Enum",
        "Erase",
        "Error",
        "Event",
        "Exit",
        "False",
        "Finally",
        "For",
        "Friend",
        "Function",
        "Get",
        "GetType",
        "GetXMLNamespace",
        "Global",
        "GoSub",
        "GoTo",
        "Handles",
        "If",
        "Implements",
        "Imports",
        "In",
        "Inherits",
        "Integer",
        "Interface",
        "Is",
        "IsNot",
        "Let",
        "Lib",
        "Like",
        "Long",
        "Loop",
        "Me",
        "Mod",
        "Module",
        "MustInherit",
        "MustOverride",
        "MyBase",
        "MyClass",
        "Namespace",
        "Narrowing",
        "New",
        "Next",
        "Not",
        "Nothing",
        "NotInheritable",
        "NotOverridable",
        "Object",
        "On",
        "Operator",
        "Option",
        "Optional",
        "Or",
        "OrElse",
        "Overloads",
        "Overridable",
        "Overrides",
        "ParamArray",
        "Partial",
        "Private",
        "Property",
        "Protected",
        "Public",
        "RaiseEvent",
        "ReadOnly",
        "ReDim",
        "REM",
        "RemoveHandler",
        "Resume",
        "Return",
        "SByte",
        "Select",
        "Set",
        "Shadows",
        "Shared",
        "Short",
        "Single",
        "Static",
        "Step",
        "Stop",
        "String",
        "Structure",
        "Sub",
        "SyncLock",
        "Then",
        "Throw",
        "To",
        "True",
        "Try",
        "TryCast",
        "TypeOf",
        "UInteger",
        "ULong",
        "UShort",
        "Using",
        "When",
        "While",
        "Widening",
        "With",
        "WithEvents",
        "WriteOnly",
        "Xor",
    ],
    "WebAssembly": [
        "anyref",
        "data",
        "element",
        "export",
        "externref",
        "f32",
        "f64",
        "func",
        "funcref",
        "global",
        "i32",
        "i64",
        "import",
        "local",
        "memory",
        "module",
        "mut",
        "offset",
        "param",
        "result",
        "start",
        "table",
        "type",
    ],
    "YAML": [
        "---",
        "...",
        "- ",
        "?",
        "|",
        ">",
        "&",
        "*",
        "!",
        "~",
        "true",
        "false",
        "null",
        "Null",
        "NULL",
    ],
    "INI": [],
    "Java": [
        "abstract",
        "assert",
        "boolean",
        "break",
        "byte",
        "case",
        "catch",
        "char",
        "class",
        "const",
        "continue",
        "default",
        "do",
        "double",
        "else",
        "enum",
        "extends",
        "final",
        "finally",
        "float",
        "for",
        "goto",
        "if",
        "implements",
        "import",
        "instanceof",
        "int",
        "interface",
        "long",
        "native",
        "new",
        "null",
        "package",
        "private",
        "protected",
        "public",
        "return",
        "short",
        "static",
        "strictfp",
        "super",
        "switch",
        "synchronized",
        "this",
        "throw",
        "throws",
        "transient",
        "true",
        "try",
        "void",
        "volatile",
        "while",
        "record",
        "sealed",
        "permits",
        "non-sealed",
    ],
    "JavaScript": [
        "await",
        "break",
        "case",
        "catch",
        "class",
        "const",
        "continue",
        "debugger",
        "default",
        "delete",
        "do",
        "else",
        "enum",
        "export",
        "extends",
        "false",
        "finally",
        "for",
        "function",
        "if",
        "import",
        "in",
        "instanceof",
        "let",
        "new",
        "null",
        "return",
        "super",
        "switch",
        "this",
        "throw",
        "true",
        "try",
        "typeof",
        "var",
        "void",
        "while",
        "with",
        "yield",
    ],
    "JSON": ["false", "null", "true"],
    "Kotlin": [
        "abstract",
        "actual",
        "annotation",
        "as",
        "break",
        "by",
        "catch",
        "class",
        "companion",
        "const",
        "constructor",
        "continue",
        "crossinline",
        "data",
        "delegate",
        "do",
        "dynamic",
        "else",
        "enum",
        "expect",
        "external",
        "false",
        "field",
        "file",
        "final",
        "finally",
        "for",
        "fun",
        "get",
        "if",
        "implements",
        "import",
        "in",
        "infix",
        "init",
        "inline",
        "inner",
        "interface",
        "internal",
        "is",
        "lateinit",
        "noinline",
        "null",
        "object",
        "open",
        "operator",
        "out",
        "override",
        "package",
        "param",
        "private",
        "property",
        "protected",
        "public",
        "receiver",
        "reified",
        "return",
        "sealed",
        "set",
        "setparam",
        "super",
        "suspend",
        "tailrec",
        "this",
        "throw",
        "true",
        "try",
        "typealias",
        "val",
        "var",
        "vararg",
        "when",
        "where",
        "while",
    ],
    "Less": [
        "@arguments",
        "@charset",
        "@container",
        "@default",
        "@import",
        "@keyframes",
        "@media",
        "@page",
        "@plugin",
        "@supports",
        "@rest",
        "each",
        "when",
    ],
    "Lua": [
        "and",
        "break",
        "do",
        "else",
        "elseif",
        "end",
        "false",
        "for",
        "function",
        "goto",
        "if",
        "in",
        "local",
        "nil",
        "not",
        "or",
        "repeat",
        "return",
        "then",
        "true",
        "until",
        "while",
    ],
    "Makefile": [
        "call",
        "define",
        "else",
        "endef",
        "endif",
        "error",
        "eval",
        "export",
        "ifdef",
        "ifndef",
        "ifeq",
        "ifneq",
        "include",
        "info",
        "override",
        "shell",
        "unexport",
        "vpath",
        "warning",
    ],
    "XML": [
        "<![CDATA[",
        "<!DOCTYPE",
        "<?xml",
        "</",
        "/>",
    ],
    "Markdown": [
        "```",
        "#",
        "##",
        "---",
        ">",
        "* ",
        "- ",
        "_",
        "[",
        "](",
    ],
    "Objective-C": [
        "@autoreleasepool",
        "@catch",
        "@class",
        "@dynamic",
        "@end",
        "@finally",
        "@implementation",
        "@import",
        "@interface",
        "@optional",
        "@private",
        "@property",
        "@protected",
        "@protocol",
        "@public",
        "@required",
        "@selector",
        "@synchronized",
        "@synthesize",
        "@try",
        "auto",
        "break",
        "case",
        "char",
        "const",
        "continue",
        "default",
        "do",
        "double",
        "else",
        "enum",
        "extern",
        "float",
        "for",
        "goto",
        "if",
        "inline",
        "int",
        "long",
        "register",
        "restrict",
        "return",
        "short",
        "signed",
        "sizeof",
        "static",
        "struct",
        "switch",
        "typedef",
        "union",
        "unsigned",
        "void",
        "volatile",
        "while",
        "_Bool",
        "_Complex",
        "_Imaginary",
    ],
}


def build_feature_tokens(reserved_words: dict[str, list[str]]) -> list[str]:
    tokens: set[str] = set()
    for words in reserved_words.values():
        for token in words:
            if token:
                tokens.add(token)
    return sorted(tokens)


SNIPPET_LENGTH_FEATURE = "SnippetLength"
FEATURE_TOKENS = build_feature_tokens(RESERVED_WORDS_BY_LANGUAGE) + [
    SNIPPET_LENGTH_FEATURE
]


def extract_features(snippet: str) -> list[bool]:
    result = []
    for token in FEATURE_TOKENS:
        if token == SNIPPET_LENGTH_FEATURE:
            result.append(len(snippet))
            continue
        count = snippet.count(token)
        result.append(count / len(snippet))
    return result
    # return [token in text for token in FEATURE_TOKENS]


def extract_features_batch(snippets: list[str]) -> dict[str, list[bool]]:
    features: dict[str, list[bool]] = {token: [] for token in FEATURE_TOKENS}
    for snippet in snippets:
        row = extract_features(snippet)
        for token, value in zip(FEATURE_TOKENS, row, strict=True):
            features[token].append(value)
    return features


dataset = get_stack_data()

with stopwatch("extract features") as sw:
    features = dataset.map(
        lambda batch: extract_features_batch(batch["Snippet"]),
        batched=True,
    )
    run_time = sw.get_time_ms()

drop_cols = list(set(dataset.column_names) - {"Language"})
features = features.remove_columns(drop_cols)
features = features.rename_column("Language", "Target")

items_per_second = len(features) / (run_time / 1000)
print(f"items/second: {items_per_second:,.0f}")

features.to_parquet("features.parquet")
